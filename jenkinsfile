pipeline {
    agent any

    stages {
        stage("clean workspace") {
            steps {
                // Clean before build
                cleanWs()
            }
        }

        stage("checkout scm") {
            steps {
                checkout scm
            }
        }

        stage("nuget") {
            steps {
                echo "Restoring NuGet packages"
                bat "dotnet restore"
            }
        }

        stage("build") {
            steps {
                echo "Build solution"
                bat "dotnet build --configuration Release"
            }
        }

        stage("test") {
            steps {
                echo "Run tests"
                bat "dotnet test .\\InoDayJenkins.Tests\\InoDayJenkins.Tests.csproj"
            }
        }

        stage("publish") {
            steps {
                echo "Deploy to staging server"
                bat "if exist .\\publish (rmdir /s /q .\\publish)"
                bat "dotnet publish --configuration Release -p:PublishDir=.\\publish"
            }
        }

        stage("deploy") {
            steps {
                echo "Copy files"
                bat "xcopy .\\publish E:\\INetPub\\JekninsInnoDay\\STAE /E /H /C /I /Y"
                bat "dir E:\\INetPub\\JekninsInnoDay\\STAE"
            }
        }

        stage("run") {
            steps {
                echo "Task kill and start new process"
                bat "taskkill /IM InoDayJenkins.exe /F /fi \"memusage gt 2\""
                bat "start /min E:\\INetPub\\JekninsInnoDay\\STAE\\InoDayJenkins.exe"
            }
        }

        stage("clean workspace") {
            steps {
                cleanWs()
            }
        }
    }
}